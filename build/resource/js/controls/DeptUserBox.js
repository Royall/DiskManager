define(["jquery","underscore","controls/Common","controls/Ajax","controls/Dialog","text!../../template/deptUserBox.html","i18n/"+global.language,"zTree"],function(e,t,n,r,i,s,o,u){var a=function(e){return this.opts=e,this.el=e.el,this.dataAPI=t.extend({},n.APIObj,{fnName:{searchUser:"user:searchUser",getDeptUsers:"user:getDeptUsers"}}),this.html=s,this.selected=[],this.selectedObj={},this.searchData=[],this.model={pageNo:1,deptPageSize:100,pageSize:10,deptId:0,deptIds:[0],searchPageNo:1},this.pageModel={},this.init(),this};return a.prototype={init:function(){this.render(),this.getTopDpt(this.opts.corpId),this.initEvents()},initEvents:function(){var t=this;e("#deptUserBox").off("click").on("click","#clear",function(){t.clear()}).on("click",".i-deletB",function(){t.deleteSelected(e(this))}).on("keyup",".addGInput",function(n){var r=e(this).val();r==""?(e(".deptUser-list").show(),e(".search-list").hide()):n.keyCode==13&&(t.model.searchPageNo=1,t.search())}).on("click","#boxBtn-search",function(){t.model.searchPageNo=1,t.search()}).on("click",".search-list ul li",function(){var n=e(this).data("index"),r=t.searchData[n];t.addSelected(r)}).on("click",".btn-more",function(){var n=e(this).data("corpid"),r=[e(this).data("deptid")];t.getUser({corpId:n,deptIds:r,pageNo:t.pageModel[r]+1}),e(this).text(o.common.loading)}).on("click",".btn-search-more",function(){t.model.searchPageNo+=1,t.search(),e(this).text(o.common.loading)})},render:function(){e(this.el).html(t.template(this.html)({Lang:o}))},addSelected:function(t){if(this.selectedObj[t.uid])return;this.selected.push(t),this.selectedObj[t.uid]=!0;var n=['<li data-uid="',t.uid,'" title="',t.name,t.email?" ("+t.email+")":"",'"><span>',t.name,'</span><a href="javascript:;"><i class="i-deletB"></i></a></li>'].join("");e(".addGListRs ul").append(n)},deleteSelected:function(e){var t=e.parents("li").index(),n=this.selected.splice(t,1)[0];this.selectedObj[n.uid]&&delete this.selectedObj[n.uid],e.parents("li").remove()},clear:function(){this.selectedObj={},this.selected=[],e(".addGListRs ul").html("")},getSelected:function(){return this.selected},search:function(){var t=e(".addGInput").val();if(t=="")return;var n=this,s={url:n.dataAPI.getUrlByFnName("searchUser")+"&page="+n.model.searchPageNo+"&pagesize="+n.model.pageSize+"&matchrule=like",data:{corpId:n.opts.corpId,name:t,email:t},success:function(t){n.model.searchPageNo=t.pageNo;var r=Math.ceil(t.total/n.model.pageSize),i=e(".btn-search-more");t.pageNo>=r?i.hide():i.text(o.common.loadMore).show();var s=t.users;n.renderList(s)},error:function(){i.tips(o.common.searchFail)}};r.request(s)},renderList:function(n){var r=this;this.model.searchPageNo==1?this.searchData=n:this.searchData=this.searchData.concat(n);var i=e(".search-result");n.length==0?i.text(o.userManager.noResult):i.text(o.userManager.searchResult+"ï¼š"),e(".search-list").show(),e(".deptUser-list").hide();var s=e(".search-list ul");this.model.searchPageNo==1&&s.html("");var u=[];t.each(n,function(e,t){u.push(["<li ",t==0?"":"",'data-index="',(r.model.searchPageNo-1)*r.model.pageSize+t,'"><div class="list-name">',e.name,'</div><div class="list-email">',e.email,"</div></li>"].join(""))}),s.append(u)},getTopDpt:function(t){var n=this,i={url:n.dataAPI.getUrlByFnName("getDeptUsers")+"&page=1&pagesize="+n.model.deptPageSize+"&type=subgrp",data:{corpId:t,deptIds:["0"]},success:function(e){var t=e.depts;n.initTree(t)},error:function(t){e(".deptLoad").html(o.common.loadFail)}};r.request(i)},getUser:function(t){var n=this;n.model.corpId=t.corpId,n.model.deptIds=t.deptIds;var i={url:n.dataAPI.getUrlByFnName("getDeptUsers")+"&page="+t.pageNo+"&pagesize="+n.model.pageSize+"&type="+(t.alluser?"alluser":"user"),data:t,success:function(r){var i=r.users;if(r.users.length==0)return;var s=Math.ceil(r.total/n.model.pageSize);n.pageModel[t.deptIds]=r.pageNo;var u=e.fn.zTree.getZTreeObj("deptUser-list"),a=u.getNodesByParam("deptId",t.deptIds[0],null),f=a[0];u.addNodes(f,i),r.pageNo==1&&t.treeNode&&e("#"+t.treeNode.tId).append('<a class="btn-more btn-more-'+t.deptIds[0]+'" data-deptid="'+t.deptIds[0]+'" data-corpid="'+t.corpId+'" href="javascript:;">'+o.common.loadMore+"</a>");var l=e(".btn-more-"+t.deptIds[0]);l.text(o.common.loadMore),r.pageNo>=s&&l.hide()},error:function(){}};r.request(i)},initTree:function(n){function s(t,n){var r=e("#"+n.tId);n.uid&&r.addClass("isUser");var i=15,s=e("#"+n.tId+"_switch"),o=e("#"+n.tId+"_ico");s.remove(),o.before(s);var u="<span style='display: inline-block;width:"+i*n.level+"px'></span>";s.before(u)}var r=this,i={view:{showLine:!1,showIcon:!1,selectedMulti:!1,dblClickExpand:!1,addDiyDom:s},data:{simpleData:{enable:!0,idKey:"deptId",pIdKey:"parentId",rootPid:0}},async:{type:"POST",enable:!0,url:r.dataAPI.getUrlByFnName("getDeptUsers")+"&type=subgrp",contentType:"text/plain; charset=UTF-8",deptParam:["corpId","deptId"],dataFilter:function(e,n,r){if(r&&r.code=="S_OK"&&r["var"])return t.map(r["var"].depts,function(e){return e.isParent=!e.leaf}),r["var"].depts}},callback:{onClick:function(e,t,n,i){var s=n.corpId,o=n.deptId;if(n.uid)r.addSelected(n);else if(n.leaf){if(r.pageModel[o]>=1)return;r.getUser({treeNode:n,corpId:s,deptIds:[o],pageNo:1})}else this.getZTreeObj(t).expandNode(n)}}};t.map(n,function(e){return e.isParent=!e.leaf}),e.fn.zTree.init(e("#deptUser-list"),i,n)}},a});