define(["jquery","underscore","controls/Common","controls/Ajax","controls/Dialog","text!../../template/deptUserBox.html","i18n/"+global.language,"zTree"],function(e,t,n,r,i,s,o,u){var a=function(e){return this.opts=e,this.el=e.el,this.dataAPI=t.extend({},n.APIObj,{fnName:{searchUser:"user:searchUser",getDeptUsers:"user:getDeptUsers"}}),this.html=s,this.selected=[],this.selectedObj={},this.searchData=[],this.model={pageNo:1,deptPageSize:100,pageSize:10,deptId:0,deptIds:[0],searchPageNo:1},this.pageModel={},this.loadedData={},this.init(),this};return a.prototype={init:function(){this.render(),this.getTopDpt(this.opts.corpId),this.initEvents()},initEvents:function(){var t=this;e("#deptUserBox").off("click").on("click","#clear",function(){t.clear()}).on("click",".i-deletB",function(){t.deleteSelected(e(this))}).on("keyup",".addGInput",function(n){var r=e(this).val();r==""?(e(".deptUser-list").show(),e(".search-list").hide()):n.keyCode==13&&(t.model.searchPageNo=1,t.search())}).on("click","#boxBtn-search",function(){t.model.searchPageNo=1,t.search()}).on("click",".search-list ul li",function(){var n=e(this).data("index"),r=t.searchData[n];t.addSelected(r)}).on("click",".btn-more",function(){var n=e(this).data("corpid"),r=[e(this).data("deptid")];t.getUser({corpId:n,deptIds:r,pageNo:t.pageModel[r]+1}),e(this).text(o.common.loading)}).on("click",".btn-search-more",function(){t.model.searchPageNo+=1,t.search(),e(this).text(o.common.loading)})},render:function(){e(this.el).html(t.template(this.html)({Lang:o}))},addSelected:function(t){if(this.selectedObj[t.uid])return;this.selected.push(t),this.selectedObj[t.uid]=!0;var n=['<li data-uid="',t.uid,'" title="',t.name,t.email?" ("+t.email+")":"",'"><span>',t.userId,'</span><a href="javascript:;"><i class="i-deletB"></i></a></li>'].join("");e(".addGListRs ul").append(n)},deleteSelected:function(e){var t=e.parents("li").index(),n=this.selected.splice(t,1)[0];this.selectedObj[n.uid]&&delete this.selectedObj[n.uid],e.parents("li").remove()},clear:function(){this.selectedObj={},this.selected=[],e(".addGListRs ul").html("")},getSelected:function(){return this.selected},search:function(){var t=e(".addGInput").val();if(t=="")return;var n=this;if(n.isLoading)return;var s={url:n.dataAPI.getUrlByFnName("searchUser")+"&page="+n.model.searchPageNo+"&pagesize="+n.model.pageSize+"&matchrule=like",data:{corpId:n.opts.corpId,userId:t,email:t},success:function(t){n.isLoading=!1,n.model.searchPageNo=t.pageNo;var r=Math.ceil(t.total/n.model.pageSize),i=e(".btn-search-more");t.pageNo>=r?i.hide():i.text(o.common.loadMore).show();var s=t.users;n.renderList(s)},error:function(){n.isLoading=!1,i.tips(o.common.searchFail)}};n.isLoading=!0,r.request(s)},renderList:function(n){var r=this;this.model.searchPageNo==1?this.searchData=n:this.searchData=this.searchData.concat(n);var i=e(".search-result");n.length==0?i.text(o.userManager.noResult):i.text(o.userManager.searchResult+"："),e(".search-list").show(),e(".deptUser-list").hide();var s=e(".search-list ul");this.model.searchPageNo==1&&s.html("");var u=[];t.each(n,function(e,t){u.push(["<li ",t==0?"":"",'data-index="',(r.model.searchPageNo-1)*r.model.pageSize+t,'"><div class="list-name" title="',e.name,'">',e.userId,'</div><div class="list-email">',e.email,"</div></li>"].join(""))}),s.append(u)},getTopDpt:function(n){var i=this,s={url:i.dataAPI.getUrlByFnName("getDeptUsers")+"&page=1&pagesize="+i.model.deptPageSize+"&type=subgrp",data:{corpId:n,deptIds:["0"]},success:function(e){var r=e.depts;e.depts.unshift({corpId:n,deptId:"all",leaf:!0,name:"所有用户",parentId:"all",ucount:1}),t.each(e.depts,function(e){e.showName=e.name}),i.initTree(r)},error:function(t){e(".deptLoad").html(o.common.loadFail)}};r.request(s)},getUser:function(n){var i=this;if(i.isLoading)return;i.model.corpId=n.corpId,i.model.deptIds=n.deptIds,i.loadedData[n.deptIds[0]]=!0;var s=n.deptIds.concat()[0];n.deptIds[0]=="all"&&(n.deptIds[0]=0);var u={url:i.dataAPI.getUrlByFnName("getDeptUsers")+"&page="+n.pageNo+"&pagesize="+i.model.pageSize+"&type="+(n.alluser?"alluser":"user"),data:n,success:function(r){i.isLoading=!1;var u=r.users;if(r.users.length==0)return;t.each(u,function(e){e.showName=e.userId});var a=Math.ceil(r.total/i.model.pageSize);i.pageModel[s]=r.pageNo;var f=e.fn.zTree.getZTreeObj("deptUser-list"),l=f.getNodesByParam("deptId",s,null),c=l[0];f.addNodes(c,u),r.pageNo==1&&n.treeNode&&e("#"+n.treeNode.tId).append('<a class="btn-more btn-more-'+s+'" data-deptid="'+s+'" data-corpid="'+n.corpId+'" href="javascript:;">'+o.common.loadMore+"</a>");var h=e(".btn-more-"+s);h.text(o.common.loadMore),r.pageNo>=a&&h.remove()},error:function(){i.isLoading=!1}};i.isLoading=!0,r.request(u)},getDept:function(n){var i=this;i.model.corpId=n.corpId,i.model.deptIds=n.deptIds;var s={url:i.dataAPI.getUrlByFnName("getDeptUsers")+"&page="+n.pageNo+"&pagesize="+i.model.deptPageSize+"&type=subgrp",data:n,success:function(r){i.loadedData[n.deptIds[0]]=!0;var s=r.depts;if(s==0)return;t.map(s,function(e){return e.showName=e.name,e.isParent=!e.leaf||!!e.ucount});var o=e.fn.zTree.getZTreeObj("deptUser-list"),u=o.getNodesByParam("deptId",n.deptIds[0],null),a=u[0];o.addNodes(a,s)},error:function(){}};r.request(s)},initTree:function(n){function s(t,n){var r=e("#"+n.tId);n.uid&&r.addClass("isUser");var i=15,s=e("#"+n.tId+"_switch"),o=e("#"+n.tId+"_ico");s.remove(),o.before(s);var u="<span style='display: inline-block;width:"+i*n.level+"px'></span>";s.before(u)}var r=this,i={view:{showLine:!1,showIcon:!1,selectedMulti:!1,dblClickExpand:!1,addDiyDom:s},data:{key:{name:"showName",title:"name"},simpleData:{enable:!0,idKey:"deptId",pIdKey:"parentId",rootPid:0}},async:{type:"POST",enable:!1,url:r.dataAPI.getUrlByFnName("getDeptUsers")+"&type=subgrp",contentType:"text/plain; charset=UTF-8",deptParam:["corpId","deptId"],dataFilter:function(e,n,r){if(r&&r.code=="S_OK"&&r["var"])return t.map(r["var"].depts,function(e){return e.isParent=!e.leaf}),r["var"].depts}},callback:{onClick:function(e,t,n,i){n.uid?r.addSelected(n):this.getZTreeObj(t).expandNode(n,null,null,null,!0)},onExpand:function(t,n,i){var s=e("#"+i.tId).find(".btn-more");s.length&&s.show();var o=i.corpId,u=i.deptId,a=i.ucount;if(r.loadedData[u])return;i.leaf||r.getDept({treeNode:i,corpId:o,deptIds:[u],pageNo:1}),a&&r.getUser({treeNode:i,corpId:o,deptIds:[u],pageNo:1})},beforeCollapse:function(t,n){var r=e("#"+n.tId).find(".btn-more");r.length&&r.hide()}}};t.map(n,function(e){return e.isParent=!e.leaf||e.ucount}),e.fn.zTree.init(e("#deptUser-list"),i,n)}},a});