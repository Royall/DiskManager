define(["jquery","underscore","controls/Common","controls/Ajax","controls/Dialog","text!../../template/deptUserBox.html","i18n/"+global.language,"zTree"],function(e,t,n,r,i,s,o,u){var a=function(e){return this.opts=e,this.el=e.el,this.html=s,this.selected=[],this.selectedObj={},this.searchData=[],this.model={pageNo:1,deptPageSize:1e3,pageSize:20,deptId:0,deptIds:[0],searchPageNo:1},this.pageModel={},this.loadedData={},this.init(),this};return a.prototype={init:function(){this.render(),this.getTopDpt(this.opts.corpId),this.initEvents()},initEvents:function(){var t=this;e("#deptUserBox").off("click").on("click","#clear",function(){t.clear()}).on("click",".i-deletB",function(){t.deleteSelected(e(this))}).on("keyup",".addGInput",function(n){var r=e(this).val();r==""?(e(".deptUser-list").show(),e(".search-list").hide()):n.keyCode==13&&(t.model.searchPageNo=1,t.search())}).on("click","#boxBtn-search",function(){t.model.searchPageNo=1,t.search()}).on("click",".search-list ul li",function(){var n=e(this).data("index"),r=t.searchData[n];t.addSelected(r)}).on("click",".btn-more",function(){var n=e(this).data("corpid"),r=[e(this).data("deptid")];t.getUser({corpId:n,deptIds:r,pageNo:t.pageModel[r]+1,alluser:e(this).data("alluser")===!0}),e(this).text(o.common.loading)}).on("click",".btn-search-more",function(){t.model.searchPageNo+=1,t.search(),e(this).text(o.common.loading)})},render:function(){e(this.el).html(t.template(this.html)({Lang:o}))},addSelected:function(t){if(this.selectedObj[t.uid])return;this.selected.push(t),this.selectedObj[t.uid]=!0;var n=['<li data-uid="',t.uid,'" title="',t.name,t.email?" ("+t.email+")":"",'"><span>',t.userId,'</span><a href="javascript:;"><i class="i-deletB"></i></a></li>'].join("");e(".addGListRs ul").append(n)},deleteSelected:function(e){var t=e.parents("li").index(),n=this.selected.splice(t,1)[0];this.selectedObj[n.uid]&&delete this.selectedObj[n.uid],e.parents("li").remove()},clear:function(){this.selectedObj={},this.selected=[],e(".addGListRs ul").html("")},getSelected:function(){return this.selected},search:function(){var t=e(".addGInput").val();if(t=="")return;var s=this;if(s.isLoading)return;var u={url:n.getUrlByName("searchUser")+"&page="+s.model.searchPageNo+"&pagesize="+s.model.pageSize+"&matchrule=like",data:{corpId:s.opts.corpId,userId:t,email:t},success:function(t){s.isLoading=!1,s.model.searchPageNo=t.pageNo;var n=Math.ceil(t.total/s.model.pageSize),r=e(".btn-search-more");t.pageNo>=n?r.hide():r.text(o.common.loadMore).show();var i=t.users;s.renderList(i)},fail:function(e){s.isLoading=!1,i.tips(n.mergeErrMsg(o.common.searchFail,e))}};s.isLoading=!0,r.request(u)},renderList:function(n){var r=this;this.model.searchPageNo==1?this.searchData=n:this.searchData=this.searchData.concat(n);var i=e(".search-result");n.length==0?i.text(o.userManager.noResult):i.text(o.userManager.searchResult+"："),e(".search-list").show(),e(".deptUser-list").hide();var s=e(".search-list ul");this.model.searchPageNo==1&&s.html("");var u=[];t.each(n,function(e,t){u.push(["<li ",t==0?"":"",'data-index="',(r.model.searchPageNo-1)*r.model.pageSize+t,'"><div class="list-name" title="',e.name,'">',e.userId,'</div><div class="list-email">',e.email,"</div></li>"].join(""))}),s.append(u)},getTopDpt:function(i){var s=this,u={url:n.getUrlByName("getDeptUsers")+"&page=1&pagesize="+s.model.deptPageSize+"&type=subgrp",data:{corpId:i,deptIds:["0"]},success:function(e){var n=e.depts;e.depts.unshift({corpId:i,deptId:"all",leaf:!0,name:"所有用户",parentId:"all",ucount:1}),t.each(e.depts,function(e){e.showName=e.name}),s.initTree(n)},fail:function(t){e(".deptLoad").html(o.common.loadFail)}};r.request(u)},getUser:function(i){var s=this;if(s.isLoading)return;s.model.corpId=i.corpId,s.model.deptIds=i.deptIds,s.loadedData[i.deptIds[0]]=!0;var u=i.deptIds.concat()[0];i.deptIds[0]=="all"&&(i.deptIds[0]=0);var a=t.extend({},i);delete a.treeNode;var f={url:n.getUrlByName("getDeptUsers")+"&page="+i.pageNo+"&pagesize="+s.model.pageSize+"&type="+(i.alluser?"alluser":"user"),data:a,success:function(n){s.isLoading=!1;var r=n.users;if(n.users.length==0)return;t.each(r,function(e){e.showName=e.userId});var a=Math.ceil(n.total/s.model.pageSize);s.pageModel[u]=n.pageNo;var f=e.fn.zTree.getZTreeObj("deptUser-list"),l=f.getNodesByParam("deptId",u,null),c=l[0];f.addNodes(c,r),n.pageNo==1&&i.treeNode&&e("#"+i.treeNode.tId).append('<a data-alluser="'+i.alluser+'" class="btn-more btn-more-'+u+'" data-deptid="'+u+'" data-corpid="'+i.corpId+'" href="javascript:;">'+o.common.loadMore+"</a>");var h=e(".btn-more-"+u);h.text(o.common.loadMore),n.pageNo>=a&&h.remove()},fail:function(){s.isLoading=!1}};s.isLoading=!0,r.request(f)},getDept:function(i){var s=this;s.model.corpId=i.corpId,s.model.deptIds=i.deptIds;var o=t.extend({},i);delete o.treeNode;var u={url:n.getUrlByName("getDeptUsers")+"&page="+i.pageNo+"&pagesize="+s.model.deptPageSize+"&type=subgrp",data:o,success:function(n){s.loadedData[i.deptIds[0]]=!0;var r=n.depts;if(r.length==0)return;t.map(r,function(e){return e.showName=e.name,e.isParent=!e.leaf||!!e.ucount});var o=e.fn.zTree.getZTreeObj("deptUser-list"),u=o.getNodesByParam("deptId",i.deptIds[0],null),a=u[0];o.addNodes(a,r)},fail:function(){}};r.request(u)},initTree:function(r){function o(t,n){var r=e("#"+n.tId);n.uid&&r.addClass("isUser");var i=15,s=e("#"+n.tId+"_switch"),o=e("#"+n.tId+"_ico");s.remove(),o.before(s);var u="<span style='display: inline-block;width:"+i*n.level+"px'></span>";s.before(u)}var i=this,s={view:{showLine:!1,showIcon:!1,selectedMulti:!1,dblClickExpand:!1,addDiyDom:o},data:{key:{name:"showName"},simpleData:{enable:!0,idKey:"deptId",pIdKey:"parentId",rootPid:0}},async:{type:"POST",enable:!1,url:n.getUrlByName("getDeptUsers")+"&type=subgrp",contentType:"text/plain; charset=UTF-8",deptParam:["corpId","deptId"],dataFilter:function(e,n,r){if(r&&r.code=="S_OK"&&r["var"])return t.map(r["var"].depts,function(e){return e.isParent=!e.leaf}),r["var"].depts}},callback:{onClick:function(e,t,n,r){n.uid?i.addSelected(n):this.getZTreeObj(t).expandNode(n,null,null,null,!0)},onExpand:function(t,n,r){var s=e("#"+r.tId).find(".btn-more");s.length&&s.show();var o=r.corpId,u=r.deptId,a=r.ucount;if(i.loadedData[u])return;r.leaf||i.getDept({treeNode:r,corpId:o,deptIds:[u],pageNo:1}),a&&i.getUser({treeNode:r,corpId:o,deptIds:[u],pageNo:1,alluser:r.deptId==="all"})},beforeCollapse:function(t,n){var r=e("#"+n.tId).find(".btn-more");r.length&&r.hide()}}};t.map(r,function(e){return e.isParent=!e.leaf||e.ucount}),e.fn.zTree.init(e("#deptUser-list"),s,r)}},a});